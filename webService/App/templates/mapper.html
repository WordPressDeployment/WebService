{% extends "layout.html" %}
{% block title %}{{title}}{% endblock %}
{% block page %}{{title}}{% endblock %}

{{ super() }}

{% block content %}
<style>
   
    .greyed-out {
        opacity: 0.5; 
    }
</style>
<body>
    <div class="container">
        <h1>Data Mapping</h1>
        <div class="row">
            <div class="col">
                <h2>Web Service Data</h2>
                <table id="webServiceTable" class="table table-striped table-bordered">
                    <!-- Table header -->
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Action</th> <!-- Button column -->
                        </tr>
                    </thead>                  
                    <tbody>
                        {% for row in data %}
                            <tr data-id="{{ row.id }}" class="web-service-row">
                                <td>{{ row.id }}</td>
                                <td>{{ row.sysUUID }}</td>
                        
                                <td>
                                    <button type="button" class="btn btn-primary btn-sm btn-map">Map</button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="col">
                <h2>API Data</h2>
                <table id="apiDataTable" class="table table-striped table-bordered">
                    
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>COTT ID</th> <!-- cott_id field to update -->
                            <th>Action</th> <!-- Button column -->
                        </tr>
                    </thead>
                    
                    <tbody>
                        {% for row in api_data %}
                            <tr data-id="{{ row.cott_id }}" class="api-data-row">
                                <td>{{ row._id }}</td>
                                <td>{{ row.title }}</td>
                                <td class="cott-id">{{ row.cott_id }}</td>
                                <td>
                                    <button type="button" class="btn btn-primary btn-sm btn-map">Map</button>
                                </td>
                                
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        $(document).ready(function() {
        var webServiceTable = $('#webServiceTable').DataTable();
        var apiDataTable = $('#apiDataTable').DataTable();

    
        var mappingState = {};

      
        $('.btn-map').click(function() {
        var $button = $(this);
        var $row = $button.closest('tr');
        var webServiceId = $row.attr('data-id');
        var cottIdElement = $row.find('.cott-id');
        var isMapped = cottIdElement.text().trim() !== '';

        if (isMapped) {
       
            delete mappingState[webServiceId];
            cottIdElement.text('');
            $row.removeClass('greyed-out');
            $button.text('Map'); 
        } else {
           
            var targetMapped = Object.values(mappingState).includes(cottIdElement.text());
            if (!targetMapped) {
                mappingState[webServiceId] = cottIdElement.text();
                cottIdElement.text(webServiceId);
                $row.addClass('greyed-out'); 
                $button.text('Mapped'); 
            } else {
                alert('This data is already mapped to another data.');
            }
        }

        localStorage.setItem('mappingState', JSON.stringify(mappingState));

        
        webServiceTable.draw();
        apiDataTable.draw();
        });

        var storedMappingState = JSON.parse(localStorage.getItem('mappingState') || '{}');
        $('.api-data-row').each(function() {
        var $row = $(this);
        var cottIdElement = $row.find('.cott-id');
        var webServiceId = $row.attr('data-id');
        if (storedMappingState[webServiceId]) {
            $row.addClass('greyed-out');
            cottIdElement.text(storedMappingState[webServiceId]);
            $row.find('.btn-map').text('Mapped');
        }
        });
        });

    </script>
</body> 


{% endblock %}